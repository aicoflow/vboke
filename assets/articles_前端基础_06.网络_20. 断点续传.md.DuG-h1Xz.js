import{_ as a,c as i,o as t,aM as n}from"./chunks/framework.ldyE1wya.js";const g=JSON.parse('{"title":"下载","description":"","frontmatter":{},"headers":[],"relativePath":"articles/前端基础/06.网络/20. 断点续传.md","filePath":"articles/前端基础/06.网络/20. 断点续传.md"}'),l={name:"articles/前端基础/06.网络/20. 断点续传.md"};function p(e,s,h,k,d,r){return t(),i("div",null,s[0]||(s[0]=[n(`<h1 id="下载" tabindex="-1">下载 <a class="header-anchor" href="#下载" aria-label="Permalink to &quot;下载&quot;">​</a></h1><p>若要实现下载时的断点续传，首先，服务器在响应时，要在头中加入下面的字段</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Accept-Ranges: bytes</span></span></code></pre></div><p>这个字段是向客户端表明：我这个文件可以支持传输部分数据，你只需要告诉我你需要的是哪一部分的数据即可，单位是字节</p><p>此时，某些支持断点续传的客户端，比如迅雷，它就可以在请求时，告诉服务器需要的数据范围。具体做法是在请求头中加入下面的字段</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>range: bytes=0-5000</span></span></code></pre></div><p>客户端告诉服务器：请给我传递0-5000字节范围内的数据即可，无须传输全部数据</p><p>完整流程如下</p><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">客户端-&gt;&gt;服务器: head请求，询问文件信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">服务器-&gt;&gt;客户端: Content-Disposition,Accept-Ranges,Content-Length</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">客户端-&gt;&gt;服务器: Range:bytes=0-500</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">服务器-&gt;&gt;客户端: 0-500字节的数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">客户端-&gt;&gt;服务器: Range:bytes=501-1000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">服务器-&gt;&gt;客户端: 501-1000字节的数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">客户端-&gt;&gt;服务器: ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">服务器-&gt;&gt;客户端: ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">客户端-&gt;&gt;客户端: 将碎片信息组装成完整文件</span></span></code></pre></div><h1 id="上传" tabindex="-1">上传 <a class="header-anchor" href="#上传" aria-label="Permalink to &quot;上传&quot;">​</a></h1><p>整体来说，实现断点上传的主要思路就是把要上传的文件切分为多个小的数据块然后进行上传</p><p><img src="http://mdrs.yuanjin.tech/img/20210918140242.png" alt="image-20210918140242356"></p><p>虽然分片上传的整体思路一致，但它没有一个统一的、具体的标准，因此需要根据具体的业务场景制定自己的标准。</p><p>由于标准的不同，这也就意味着分片上传需要自行编写代码实现。</p><p>下面用一种极其简易的流程实现分片上传</p><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Note left of 客户端: 用户选择文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Note left of 客户端: 将文件分割为多个分片</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Note left of 客户端: 得到文件的MD5和每个分片的MD5</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">客户端-&gt;&gt;服务器: 文件MD5、后缀、分片顺序、每个分片MD5</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Note right of 服务器: 文件还剩哪些分片没有上传？</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">服务器-&gt;&gt;客户端: 还需要上传的分片MD5</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">客户端-&gt;&gt;服务器: 上传一个分片</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Note right of 服务器: 文件还剩哪些分片没有上传？</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">服务器-&gt;&gt;客户端: 还需要上传的分片MD5</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">客户端-&gt;&gt;服务器: 上传一个分片</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Note right of 服务器: 文件还剩哪些分片没有上传？</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">服务器-&gt;&gt;客户端: 还需要上传的分片MD5</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">客户端-&gt;&gt;服务器: 上传一个分片</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Note right of 服务器: 所有分片已上传</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Note right of 服务器: 合并所有分片成完整的文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">服务器-&gt;&gt;客户端: 文件的访问地址</span></span></code></pre></div><h1 id="示例服务器" tabindex="-1">示例服务器 <a class="header-anchor" href="#示例服务器" aria-label="Permalink to &quot;示例服务器&quot;">​</a></h1><h2 id="下载-1" tabindex="-1">下载 <a class="header-anchor" href="#下载-1" aria-label="Permalink to &quot;下载&quot;">​</a></h2><p><a href="http://localhost:8000/download/Wallpaper1.jpg" target="_blank" rel="noreferrer">http://localhost:8000/download/Wallpaper1.jpg</a></p><p><a href="http://localhost:8000/download/Wallpaper2.jpg" target="_blank" rel="noreferrer">http://localhost:8000/download/Wallpaper2.jpg</a></p><p><a href="http://localhost:8000/download/Wallpaper3.jpg" target="_blank" rel="noreferrer">http://localhost:8000/download/Wallpaper3.jpg</a></p><p><a href="http://localhost:8000/download/Wallpaper4.jpg" target="_blank" rel="noreferrer">http://localhost:8000/download/Wallpaper4.jpg</a></p><p><a href="http://localhost:8000/download/Wallpaper5.jpg" target="_blank" rel="noreferrer">http://localhost:8000/download/Wallpaper5.jpg</a></p><p><a href="http://localhost:8000/download/Wallpaper6.jpg" target="_blank" rel="noreferrer">http://localhost:8000/download/Wallpaper6.jpg</a></p><p><a href="http://localhost:8000/download/Wallpaper7.jpg" target="_blank" rel="noreferrer">http://localhost:8000/download/Wallpaper7.jpg</a></p><p><a href="http://localhost:8000/download/Wallpaper8.jpg" target="_blank" rel="noreferrer">http://localhost:8000/download/Wallpaper8.jpg</a></p><p><a href="http://localhost:8000/download/Wallpaper9.jpg" target="_blank" rel="noreferrer">http://localhost:8000/download/Wallpaper9.jpg</a></p><p><a href="http://localhost:8000/download/Wallpaper10.jpg" target="_blank" rel="noreferrer">http://localhost:8000/download/Wallpaper10.jpg</a></p><h2 id="上传-1" tabindex="-1">上传 <a class="header-anchor" href="#上传-1" aria-label="Permalink to &quot;上传&quot;">​</a></h2><h3 id="文件信息协商" tabindex="-1">文件信息协商 <a class="header-anchor" href="#文件信息协商" aria-label="Permalink to &quot;文件信息协商&quot;">​</a></h3><p><strong>请求路径</strong>：/api/upload/handshake</p><p><strong>请求方法</strong>：POST</p><p><strong>字段</strong>：</p><table tabindex="0"><thead><tr><th>字段名</th><th>含义</th><th>是否必须</th></tr></thead><tbody><tr><td>fileId</td><td>文件的MD5编码</td><td>是</td></tr><tr><td>ext</td><td>文件的后缀，例如：.jpg</td><td>是</td></tr><tr><td>chunkIds</td><td>文件分片的编号数组，每个编号是一个MD5编码</td><td>是</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><p><strong>可能的响应</strong>：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	code</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://localhost:8000/upload/a32d18.jpg&#39;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 服务器已有该文件，无须上传</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	code</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;md5-1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;md5-2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;md5-5&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 服务器还需要上传的分片</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>可能发生的失败响应</strong>：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	code</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">403</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;请携带文件编号&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="分片上传" tabindex="-1">分片上传 <a class="header-anchor" href="#分片上传" aria-label="Permalink to &quot;分片上传&quot;">​</a></h3><p><strong>请求路径</strong>：/api/upload</p><p><strong>请求方法</strong>：POST</p><p><strong>字段</strong>：</p><table tabindex="0"><thead><tr><th>字段名</th><th>含义</th><th>是否必须</th></tr></thead><tbody><tr><td>file</td><td>分片的二进制数据</td><td>是</td></tr><tr><td>chunkId</td><td>分片的MD5编码</td><td>是</td></tr><tr><td>fileId</td><td>分片所属文件的MD5编码</td><td>是</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><p><strong>上传成功的响应</strong>：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	code</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;md5-2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;md5-5&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 服务器还需要上传的分片</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>可能发生的失败响应</strong>：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	code</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">403</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;请携带文件编号&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div>`,48)]))}const o=a(l,[["render",p]]);export{g as __pageData,o as default};
